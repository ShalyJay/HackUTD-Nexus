import React, { useState, useEffect } from "react";
import { ComplianceService } from "./services/complianceService";
import { AuditService } from "./services/auditService";
import type { AuditResult } from "./services/auditResultService";

const theme = {
  maroon: "#500000",
  gold: "#d4af37",
  warmWhite: "#FFF9F7",
  text: "#2D2D2D",
  gray: "#6b7280",
  lightGray: "#e5e7eb",
  green: "#16a34a",
  red: "#dc2626",
  orange: "#f97316"
};

interface Vendor {
  id: string;
  companyName: string;
  status: "Compliant" | "In review" | "Pending AI";
  lastDocument: string;
  riskLevel: "High Risk" | "Medium Risk" | "Low Risk";
  score: number;
  documents: {
    soc2: { status: string; date: string };
    pci: { status: string; date: string };
    iso: { status: string; date: string };
  };
}

interface Client {
  id: string;
  companyName: string;
  totalVendors: number;
  activeReviews: number;
  documents: {
    name: string;
    status: string;
    date: string;
  }[];
}

interface UserProfile {
  firstName: string;
  lastName: string;
  email: string;
  companyName: string;
  accountType: "vendors" | "clients" | "admin";
  documents: {
    soc2Cert?: File;
    iso27001Cert?: File;
    auditReports?: File;
    insuranceCert?: File;
  };
  lastAuditScore?: number;
  lastAuditDate?: string;
}

interface DashboardProps {
  userProfile: UserProfile;
  onAuditResult?: (result: AuditResult) => void;
  onAnalysisStart?: () => void;
}

export default function Dashboard({ 
  userProfile,
  onAuditResult,
  onAnalysisStart
}: DashboardProps) {
  const [selectedTab, setSelectedTab] = useState<"overview" | "profile" | "upload">("overview");
  const [selectedFiles, setSelectedFiles] = useState<FileList | null>(null);
  const [vendors, setVendors] = useState<Vendor[]>([]);
  const [clients, setClients] = useState<Client[]>([]);

  useEffect(() => {
    // Fetch data based on user role
    async function fetchData() {
      try {
        if (userProfile.accountType === "admin") {
          // Admin sees all data
          const [vendorData, clientData] = await Promise.all([
            ComplianceService.getAllVendors(),
            ComplianceService.getAllClients()
          ]);
          setVendors(vendorData);
          setClients(clientData);
        } else if (userProfile.accountType === "vendors") {
          // Vendors only see admin's client data
          const clientData = await ComplianceService.getAdminClients();
          setClients(clientData);
        } else {
          // Clients only see admin's vendor data
          const vendorData = await ComplianceService.getAdminVendors();
          setVendors(vendorData);
        }
      } catch (err) {
        console.error("Failed to fetch dashboard data:", err);
      }
    }

    fetchData();
  }, [userProfile.accountType]);

  function handleFileChange(e: React.ChangeEvent<HTMLInputElement>) {
    setSelectedFiles(e.target.files);
  }

  async function handleUpload() {
    if (!selectedFiles || selectedFiles.length === 0) return;

    try {
      onAnalysisStart?.();
      const files = Array.from(selectedFiles);

      const tempUserId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      const complianceResult = await ComplianceService.checkComplianceAndStore(tempUserId, files);
      const auditReport = await AuditService.generateAuditReport(
        tempUserId,
        complianceResult,
        userProfile.companyName
      );

      const auditResult: AuditResult = {
        tempUserId,
        status: auditReport.status,
        complianceScore: complianceResult.score,
        complianceResult: complianceResult,
        geminiSummary: auditReport.geminiSummary,
        requiredActions: auditReport.requiredActions || [],
        timestamp: auditReport.timestamp
      };

      onAuditResult?.(auditResult);
    } catch (err) {
      console.error('Upload failed:', err);
      const errorMsg = err instanceof Error ? err.message : 'Failed to process documents. Please try again.';
      alert(errorMsg);
    }
  }

  return (
    <div className="dashboard-root" style={{
      minHeight: "100vh",
      width: "100%",
      background: theme.warmWhite,
      padding: "2rem"
    }}>
      {/* Header */}
      <header style={{
        display: "flex",
        justifyContent: "space-between",
        alignItems: "center",
        marginBottom: "2rem"
      }}>
        <div>
          <h1 style={{ fontSize: "2rem", color: theme.maroon, marginBottom: "0.5rem" }}>
            Nexus One â€“ Control Center
          </h1>
          <p style={{ color: theme.gray }}>
            Managing: {vendors.length} Vendors â€¢ {clients.length} Clients
          </p>
        </div>

        <div style={{ display: "flex", alignItems: "center", gap: "1rem" }}>
          <input
            type="search"
            placeholder="Search vendors, clients, or documents..."
            style={{
              padding: "0.75rem 1rem",
              border: `1px solid ${theme.lightGray}`,
              borderRadius: 8,
              width: 300
            }}
          />
          <div style={{
            display: "flex",
            alignItems: "center",
            gap: "0.5rem",
            padding: "0.5rem 1rem",
            background: "white",
            borderRadius: 8,
            boxShadow: "0 1px 3px rgba(0,0,0,0.1)"
          }}>
            <span style={{ fontSize: 20 }}>ðŸ‘¤</span>
            <span style={{ color: theme.text }}>{userProfile.firstName}</span>
          </div>
        </div>
      </header>

      {/* Navigation Tabs */}
      <nav style={{
        display: "flex",
        gap: "1rem",
        marginBottom: "2rem",
        borderBottom: `1px solid ${theme.lightGray}`,
        padding: "0 1rem"
      }}>
        {[
          { id: "overview", label: "Dashboard" },
          { id: "profile", label: "Profile" },
          { id: "upload", label: "Upload Documents" }
        ].map(tab => (
          <button
            key={tab.id}
            onClick={() => setSelectedTab(tab.id as any)}
            style={{
              padding: "1rem",
              background: "transparent",
              border: "none",
              borderBottom: `2px solid ${selectedTab === tab.id ? theme.maroon : "transparent"}`,
              color: selectedTab === tab.id ? theme.maroon : theme.gray,
              fontWeight: selectedTab === tab.id ? 600 : 400,
              cursor: "pointer"
            }}
          >
            {tab.label}
          </button>
        ))}
      </nav>

      {/* Main Content */}
      <main style={{ padding: "1rem" }}>
        {selectedTab === "overview" && (
          <div style={{ display: "grid", gap: "2rem" }}>
            {/* Risk Overview Card */}
            <div style={{
              background: "white",
              borderRadius: 16,
              padding: "2rem",
              boxShadow: "0 4px 6px rgba(0,0,0,0.05)"
            }}>
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2rem" }}>
                <div>
                  <h2 style={{ fontSize: "1.5rem", marginBottom: "0.5rem" }}>Overall</h2>
                  <p style={{ color: theme.gray }}>Compliance Score</p>
                  <div style={{
                    fontSize: "2.5rem",
                    fontWeight: 600,
                    color: theme.maroon
                  }}>
                    82%
                    <span style={{
                      fontSize: "1rem",
                      color: theme.red,
                      marginLeft: "1rem"
                    }}>
                      â–¼ 50% in last 30 days
                    </span>
                  </div>
                </div>

                <div>
                  <h3 style={{ marginBottom: "1rem" }}>Risk Overview</h3>
                  <div style={{ display: "grid", gap: "0.5rem" }}>
                    <div style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
                      <span>Vendors</span>
                      <div style={{
                        width: 200,
                        height: 8,
                        background: "#e5e7eb",
                        borderRadius: 4,
                        overflow: "hidden"
                      }}>
                        <div style={{
                          width: "60%",
                          height: "100%",
                          background: `linear-gradient(to right, ${theme.green}, ${theme.orange}, ${theme.red})`
                        }} />
                      </div>
                    </div>
                    <div style={{ display: "flex", alignItems: "center", gap: "0.5rem" }}>
                      <span>Clients</span>
                      <div style={{
                        width: 200,
                        height: 8,
                        background: "#e5e7eb",
                        borderRadius: 4,
                        overflow: "hidden"
                      }}>
                        <div style={{
                          width: "85%",
                          height: "100%",
                          background: theme.green
                        }} />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Vendor/Client Lists */}
              {userProfile.accountType !== "vendors" && (
                <div>
                  <h3 style={{ marginBottom: "1rem" }}>Vendors</h3>
                  <div style={{ display: "grid", gap: "1rem" }}>
                    {vendors.map(vendor => (
                      <div key={vendor.id} style={{
                        display: "flex",
                        justifyContent: "space-between",
                        alignItems: "center",
                        padding: "1rem",
                        background: vendor.riskLevel === "High Risk" ? "#fee2e2" : "#f0fdf4",
                        borderRadius: 8
                      }}>
                        <div>
                          <h4>{vendor.companyName}</h4>
                          <p style={{ color: theme.gray }}>{vendor.status}</p>
                        </div>
                        <div style={{ textAlign: "right" }}>
                          <p>SOC 2: {vendor.documents.soc2.status}</p>
                          <p>Last Updated: {vendor.documents.soc2.date}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {userProfile.accountType !== "clients" && (
                <div style={{ marginTop: "2rem" }}>
                  <h3 style={{ marginBottom: "1rem" }}>Clients</h3>
                  <div style={{ display: "grid", gap: "1rem" }}>
                    {clients.map(client => (
                      <div key={client.id} style={{
                        display: "flex",
                        justifyContent: "space-between",
                        alignItems: "center",
                        padding: "1rem",
                        background: "white",
                        borderRadius: 8,
                        border: `1px solid ${theme.lightGray}`
                      }}>
                        <div>
                          <h4>{client.companyName}</h4>
                          <p style={{ color: theme.gray }}>{client.totalVendors} vendors â€¢ {client.activeReviews} active reviews</p>
                        </div>
                        <div style={{ textAlign: "right" }}>
                          <p>Latest Document: {client.documents[0]?.name}</p>
                          <p>Status: {client.documents[0]?.status}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {selectedTab === "profile" && (
          <div style={{
            background: "white",
            borderRadius: 16,
            padding: "2rem",
            boxShadow: "0 4px 6px rgba(0,0,0,0.05)"
          }}>
            <h2 style={{ marginBottom: "2rem" }}>Company Profile</h2>
            
            <div style={{ display: "grid", gap: "2rem" }}>
              <div>
                <h3 style={{ marginBottom: "1rem" }}>Basic Information</h3>
                <div style={{ display: "grid", gap: "1rem" }}>
                  <div>
                    <label style={{ color: theme.gray }}>Company Name</label>
                    <p>{userProfile.companyName}</p>
                  </div>
                  <div>
                    <label style={{ color: theme.gray }}>Account Type</label>
                    <p style={{ textTransform: "capitalize" }}>{userProfile.accountType}</p>
                  </div>
                  <div>
                    <label style={{ color: theme.gray }}>Primary Contact</label>
                    <p>{userProfile.firstName} {userProfile.lastName}</p>
                    <p>{userProfile.email}</p>
                  </div>
                </div>
              </div>

              <div>
                <h3 style={{ marginBottom: "1rem" }}>Compliance Documents</h3>
                <div style={{ display: "grid", gap: "1rem" }}>
                  {Object.entries(userProfile.documents).map(([key, file]) => (
                    <div key={key} style={{
                      display: "flex",
                      alignItems: "center",
                      padding: "1rem",
                      background: "#f9fafb",
                      borderRadius: 8,
                      gap: "1rem"
                    }}>
                      <span style={{ fontSize: 24 }}>ðŸ“„</span>
                      <div style={{ flex: 1 }}>
                        <p style={{ fontWeight: 500 }}>{key.replace(/([A-Z])/g, ' $1').trim()}</p>
                        <p style={{ color: theme.gray }}>{file?.name || "Not uploaded"}</p>
                      </div>
                      {file && <span style={{ color: theme.green }}>âœ“</span>}
                    </div>
                  ))}
                </div>
              </div>

              {userProfile.lastAuditScore && (
                <div>
                  <h3 style={{ marginBottom: "1rem" }}>Last Audit Results</h3>
                  <div style={{
                    display: "flex",
                    gap: "2rem",
                    padding: "1.5rem",
                    background: "#f9fafb",
                    borderRadius: 8
                  }}>
                    <div>
                      <p style={{ color: theme.gray }}>Compliance Score</p>
                      <p style={{ fontSize: "2rem", fontWeight: 600, color: theme.maroon }}>
                        {userProfile.lastAuditScore}%
                      </p>
                    </div>
                    <div>
                      <p style={{ color: theme.gray }}>Last Updated</p>
                      <p>{userProfile.lastAuditDate}</p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {selectedTab === "upload" && (
          <div style={{
            background: "white",
            borderRadius: 16,
            padding: "2rem",
            boxShadow: "0 4px 6px rgba(0,0,0,0.05)"
          }}>
            <h2 style={{ marginBottom: "2rem" }}>Upload New Documents</h2>
            
            <div style={{ display: "grid", gap: "2rem" }}>
              <div>
                <label style={{ 
                  display: "block", 
                  marginBottom: "0.5rem", 
                  color: theme.text 
                }}>
                  Upload Documents
                </label>
                <input
                  type="file"
                  multiple
                  onChange={handleFileChange}
                  accept=".pdf,.doc,.docx"
                  style={{
                    width: "100%",
                    padding: "2rem",
                    border: `2px dashed ${theme.lightGray}`,
                    borderRadius: 8,
                    textAlign: "center",
                    cursor: "pointer"
                  }}
                />
              </div>

              <button
                onClick={handleUpload}
                disabled={!selectedFiles}
                style={{
                  padding: "1rem",
                  background: theme.maroon,
                  color: "white",
                  border: "none",
                  borderRadius: 8,
                  cursor: selectedFiles ? "pointer" : "default",
                  opacity: selectedFiles ? 1 : 0.7
                }}
              >
                Upload & Run Compliance Check
              </button>
            </div>
          </div>
        )}
      </main>
    </div>
  );
}